<view class="chat-container">
  <!-- 账单统计区域 -->
  <view class="bill-stats">
    <view class="stat-item" bindtap="showReport" data-type="daily">
      <text class="stat-label">今日</text>
      <view class="stat-values">
        <text class="stat-value expense">-¥{{billStats.daily || 0}}</text>
        <text class="stat-value income">+¥{{billStats.dailyIncome || 0}}</text>
      </view>
    </view>
    <view class="stat-item" bindtap="showReport" data-type="monthly">
      <text class="stat-label">本月</text>
      <view class="stat-values">
        <text class="stat-value expense">-¥{{billStats.monthly || 0}}</text>
        <text class="stat-value income">+¥{{billStats.monthlyIncome || 0}}</text>
      </view>
    </view>
    <view class="stat-item" bindtap="showReport" data-type="yearly">
      <text class="stat-label">本年</text>
      <view class="stat-values">
        <text class="stat-value expense">-¥{{billStats.yearly || 0}}</text>
        <text class="stat-value income">+¥{{billStats.yearlyIncome || 0}}</text>
      </view>
    </view>
  </view>

  <!-- 报表弹窗 -->
  <view class="report-popup" wx:if="{{showReportPopup}}">
    <view class="popup-mask" bindtap="hideReport"></view>
    <view class="popup-content">
      <view class="popup-header">
        <text class="popup-title">{{reportType === 'daily' ? '今日' : reportType === 'monthly' ? '本月' : '本年'}}报表</text>
      </view>
      <view class="popup-body">
        <view class="report-summary">
          <view class="summary-item">
            <text class="summary-label">总收入</text>
            <text class="summary-value income">+¥{{reportData.totalIncome || 0}}</text>
          </view>
          <view class="summary-item">
            <text class="summary-label">总支出</text>
            <text class="summary-value expense">-¥{{reportData.totalExpense || 0}}</text>
          </view>
        </view>

        <view class="report-analysis">
          <view class="analysis-title">AI分析</view>
          <view class="analysis-content">{{reportData.analysis}}</view>
        </view>

        <view class="report-details">
          <view class="details-title">详细数据</view>
          <view class="details-list">
            <view class="details-item" wx:for="{{reportData.details}}" wx:key="index" bindtap="showDetail" data-item="{{item}}">
              <image class="item-icon" src="{{item.icon || '/assets/icons/default.png'}}" />
              <view class="item-info">
                <text class="item-category">{{item.category}}</text>
                <text class="item-name">{{item.item}}</text>
              </view>
              <text class="item-amount {{item.isIncome ? 'income' : 'expense'}}">
                {{item.isIncome ? '+' : '-'}}¥{{item.amount}}
              </text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 详情弹窗 -->
  <view class="detail-popup" wx:if="{{showDetailPopup}}">
    <view class="popup-mask" bindtap="hideDetail"></view>
    <view class="popup-content detail-content">
      <view class="popup-header">
        <text class="popup-title">账单详情</text>
        <view class="popup-actions">
          <view class="action-btn close" bindtap="hideDetail">关闭</view>
        </view>
      </view>
      <view class="popup-body">
        <view class="detail-item">
          <text class="detail-label">时间</text>
          <text class="detail-value">{{detailData.date}}</text>
        </view>
        <view class="detail-item">
          <text class="detail-label">类型</text>
          <text class="detail-value">{{detailData.category}}</text>
        </view>
        <view class="detail-item">
          <text class="detail-label">项目</text>
          <text class="detail-value">{{detailData.item}}</text>
        </view>
        <view class="detail-item">
          <text class="detail-label">金额</text>
          <text class="detail-value {{detailData.isIncome ? 'income' : 'expense'}}">
            {{detailData.isIncome ? '+' : '-'}}¥{{detailData.amount}}
          </text>
        </view>
      </view>
    </view>
  </view>

  <!-- 消息列表区域 -->
  <scroll-view 
    class="message-list" 
    scroll-y 
    scroll-into-view="{{scrollToMessage}}"
    scroll-with-animation="{{true}}"
    enhanced="{{true}}"
    show-scrollbar="{{false}}"
  >
    <block wx:for="{{messages}}" wx:key="timestamp">
      <view class="message-item {{item.isSelf ? 'self' : ''}}" id="msg-{{item.timestamp}}">
        <!-- 头像 -->
        <image class="avatar" src="{{item.isSelf ? '/assets/avatar/user.png' : '/assets/avatar/ai.png'}}" />
        
        <!-- 消息内容 -->
        <view class="message-content">
          <!-- 消费记录消息 -->
          <block wx:if="{{item.type === 'consumption'}}">
            <view class="consumption-wrapper">
              <view class="consumption-header">
                <view class="header-left">
                  <image class="success-icon" src="/assets/icons/success.png" />
                </view>
                <text class="header-right">{{item.timeStr}}</text>
              </view>
              <view class="consumption-details">
                <view class="consumption-row">
                  <image class="item-icon" src="{{item.content.icon}}" />
                  <text class="category-name">{{item.content.category}}</text>
                  <text class="item-name">{{item.content.item}}</text>
                </view>
                <view class="consumption-row">
                  <text class="income-expense">{{item.content.isIncome ? '我 收 入' : '我 支 出'}}</text>
                  <text class="item-amount {{item.content.isIncome ? 'income' : 'expense'}}">
                    {{item.content.isIncome ? '+' : '-'}}¥{{item.content.amount}}
                  </text>
                </view>
              </view>
            </view>
            <view class="action-buttons">
              <view class="action-button" bindtap="editBill" data-bill="{{item}}">
                <image src="/assets/icons/edit.png" />
              </view>
              <view class="action-button" bindtap="deleteBill" data-bill="{{item}}">
                <image src="/assets/icons/delete.png" />
              </view>
            </view>
          </block>
          
          <!-- 文本消息 -->
          <block wx:elif="{{item.type === 'text'}}">
            <view class="text-message">{{item.content}}</view>
          </block>
        </view>
      </view>
    </block>
    
    <!-- 加载状态 -->
    <view class="loading-wrapper" wx:if="{{isLoading}}">
      <view class="loading-dots">
        <view class="dot"></view>
        <view class="dot"></view>
        <view class="dot"></view>
      </view>
    </view>
  </scroll-view>

  <!-- 输入区域 -->
  <view class="input-area">
    <input 
      class="input-box" 
      value="{{inputValue}}"
      placeholder="请输入消费记录" 
      bindinput="onInput"
      bindconfirm="sendMessage"
      focus="{{inputFocus}}"
      adjust-position="{{true}}"
    />
    <view class="send-btn" bindtap="sendMessage">发送</view>
  </view>
</view>